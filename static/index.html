<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EVA - Chat</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: #0d0d0d;
                color: #ececf1;
                height: 100vh;
                overflow: hidden;
            }

            .app-container {
                display: flex;
                height: 100vh;
            }

            /* Sidebar */
            .sidebar {
                width: 260px;
                background: #1a1a1a;
                border-right: 1px solid #2d2d2d;
                display: flex;
                flex-direction: column;
                transition: transform 0.3s;
            }

            .sidebar-header {
                padding: 20px;
                border-bottom: 1px solid #2d2d2d;
            }

            .new-chat-btn {
                width: 100%;
                padding: 12px;
                background: #2d2d2d;
                border: 1px solid #404040;
                border-radius: 8px;
                color: #ececf1;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .new-chat-btn:hover {
                background: #353535;
            }

            .sidebar-content {
                flex: 1;
                overflow-y: auto;
                padding: 16px;
            }

            .sidebar-footer {
                padding: 16px;
                border-top: 1px solid #2d2d2d;
            }

            .user-info {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: #2d2d2d;
                border-radius: 8px;
                margin-bottom: 8px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                background: #10a37f;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
            }

            .user-details {
                flex: 1;
            }

            .user-name {
                font-size: 14px;
                font-weight: 600;
                color: #ececf1;
            }

            .user-id {
                font-size: 11px;
                color: #8e8ea0;
            }

            .logout-btn {
                width: 100%;
                padding: 10px;
                background: transparent;
                border: 1px solid #404040;
                border-radius: 8px;
                color: #ececf1;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .logout-btn:hover {
                background: #2d2d2d;
                border-color: #e74c3c;
                color: #e74c3c;
            }

            /* Main Chat Area */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: #0d0d0d;
            }

            .chat-header {
                padding: 16px 24px;
                border-bottom: 1px solid #2d2d2d;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .chat-title {
                font-size: 14px;
                font-weight: 600;
                color: #ececf1;
            }

            .chat-actions {
                display: flex;
                gap: 8px;
            }

            .action-btn {
                padding: 6px 12px;
                background: transparent;
                border: 1px solid #404040;
                border-radius: 6px;
                color: #8e8ea0;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .action-btn:hover {
                background: #2d2d2d;
                color: #ececf1;
            }

            .chat-area {
                flex: 1;
                overflow-y: auto;
                padding: 24px;
            }

            .chat-container {
                max-width: 768px;
                margin: 0 auto;
            }

            .message {
                margin-bottom: 24px;
                animation: fadeIn 0.3s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
            }

            .message-avatar {
                width: 28px;
                height: 28px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
            }

            .message.user .message-avatar {
                background: #5436da;
            }

            .message.bot .message-avatar {
                background: #10a37f;
            }

            .message-sender {
                font-size: 14px;
                font-weight: 600;
                color: #ececf1;
            }

            .message-badge {
                font-size: 10px;
                padding: 2px 6px;
                background: #10a37f22;
                color: #10a37f;
                border-radius: 4px;
                font-weight: 600;
            }

            .message-content {
                margin-left: 40px;
                font-size: 14px;
                line-height: 1.6;
                color: #ececf1;
            }

            .message-time {
                margin-left: 40px;
                margin-top: 4px;
                font-size: 11px;
                color: #8e8ea0;
            }

            .typing-indicator {
                display: none;
                margin-left: 40px;
            }

            .typing-indicator.active {
                display: flex;
                gap: 4px;
            }

            .typing-dot {
                width: 8px;
                height: 8px;
                background: #8e8ea0;
                border-radius: 50%;
                animation: typing 1.4s infinite;
            }

            .typing-dot:nth-child(2) {
                animation-delay: 0.2s;
            }
            .typing-dot:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing {
                0%,
                60%,
                100% {
                    transform: translateY(0);
                    opacity: 0.7;
                }
                30% {
                    transform: translateY(-10px);
                    opacity: 1;
                }
            }

            /* Input Area */
            .input-area {
                padding: 24px;
                border-top: 1px solid #2d2d2d;
            }

            .input-container {
                max-width: 768px;
                margin: 0 auto;
                position: relative;
            }

            .quick-actions {
                display: flex;
                gap: 8px;
                margin-bottom: 12px;
                flex-wrap: wrap;
            }

            .quick-btn {
                padding: 6px 12px;
                background: #2d2d2d;
                border: 1px solid #404040;
                border-radius: 16px;
                color: #ececf1;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
            }

            .quick-btn:hover {
                background: #353535;
                border-color: #10a37f;
            }

            .input-wrapper {
                position: relative;
                display: flex;
                align-items: center;
                background: #2d2d2d;
                border: 1px solid #404040;
                border-radius: 12px;
                padding: 12px 16px;
                transition: border 0.2s;
            }

            .input-wrapper:focus-within {
                border-color: #10a37f;
            }

            #messageInput {
                flex: 1;
                background: transparent;
                border: none;
                color: #ececf1;
                font-size: 14px;
                outline: none;
                resize: none;
                max-height: 120px;
            }

            #sendButton {
                width: 32px;
                height: 32px;
                background: #10a37f;
                border: none;
                border-radius: 6px;
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            #sendButton:hover {
                background: #1a7f64;
            }

            #sendButton:disabled {
                background: #404040;
                cursor: not-allowed;
            }

            .welcome-screen {
                text-align: center;
                padding: 60px 24px;
                max-width: 600px;
                margin: 0 auto;
            }

            .welcome-screen h2 {
                font-size: 32px;
                margin-bottom: 16px;
                background: linear-gradient(90deg, #10a37f, #1a7f64);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .welcome-screen p {
                color: #8e8ea0;
                font-size: 14px;
                line-height: 1.6;
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 6px;
            }

            ::-webkit-scrollbar-track {
                background: #1a1a1a;
            }

            ::-webkit-scrollbar-thumb {
                background: #404040;
                border-radius: 3px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #4a4a4a;
            }

            /* Mobile */
            @media (max-width: 768px) {
                .sidebar {
                    position: fixed;
                    left: -260px;
                    z-index: 100;
                    height: 100vh;
                }

                .sidebar.open {
                    transform: translateX(260px);
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" onclick="newChat()">
                        <span>‚ûï</span>
                        <span>New chat</span>
                    </button>
                </div>

                <div class="sidebar-content">
                    <!-- Chat history can go here -->
                </div>

                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">
                                Loading...
                            </div>
                            <div class="user-id" id="userId"></div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        üö™ Logout
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="chat-header">
                    <div class="chat-title">üí¨ Chat with EVA</div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="exportChat()">
                            üíæ Export
                        </button>
                        <button class="action-btn" onclick="clearChat()">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>

                <div class="chat-area" id="chatArea">
                    <div class="chat-container">
                        <div class="welcome-screen" id="welcomeScreen">
                            <h2>Welcome to EVA</h2>
                            <p>
                                Your personal GroundTruth Coffee assistant. Ask
                                me about your orders, nearby locations, loyalty
                                rewards, or anything else!
                            </p>
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <div class="quick-actions">
                            <button
                                class="quick-btn"
                                onclick="
                                    sendQuickMessage('What is my usual order?')
                                "
                            >
                                ‚òï My Usual
                            </button>
                            <button
                                class="quick-btn"
                                onclick="
                                    sendQuickMessage(
                                        'What discounts do I have?',
                                    )
                                "
                            >
                                üí∞ Discounts
                            </button>
                            <button
                                class="quick-btn"
                                onclick="
                                    sendQuickMessage(
                                        'Where is the nearest store?',
                                    )
                                "
                            >
                                üìç Locations
                            </button>
                            <button
                                class="quick-btn"
                                onclick="
                                    sendQuickMessage(
                                        'What are today\'s specials?',
                                    )
                                "
                            >
                                ‚≠ê Specials
                            </button>
                        </div>

                        <div class="input-wrapper">
                            <textarea
                                id="messageInput"
                                placeholder="Message EVA..."
                                rows="1"
                                autocomplete="off"
                            ></textarea>
                            <button id="sendButton">
                                <span>‚Üë</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const API_URL = "http://localhost:8000";
            const chatArea = document.getElementById("chatArea");
            const messageInput = document.getElementById("messageInput");
            const sendButton = document.getElementById("sendButton");
            const welcomeScreen = document.getElementById("welcomeScreen");

            let username = localStorage.getItem("eva_username");
            let customerData = null;

            // Check authentication
            if (!username) {
                window.location.href = "/login";
            }

            // Set user info immediately (don't wait for API)
            if (username) {
                const displayName =
                    username.charAt(0).toUpperCase() + username.slice(1);
                document.getElementById("userName").textContent = displayName;
                document.getElementById("userAvatar").textContent =
                    username[0].toUpperCase();
                document.getElementById("userId").textContent = "Connecting...";
            }

            // Load full user info
            async function loadUserInfo() {
                try {
                    const response = await fetch(`${API_URL}/users`);
                    const data = await response.json();

                    if (data.users[username]) {
                        customerData = data.users[username];
                        document.getElementById("userId").textContent =
                            customerData.customer_id;
                    } else {
                        document.getElementById("userId").textContent =
                            "New User";
                    }
                } catch (error) {
                    console.error("Error loading user info:", error);
                    document.getElementById("userId").textContent = "Guest";
                }
            }

            // Load user info after page loads
            setTimeout(loadUserInfo, 100);

            // Auto-resize textarea
            messageInput.addEventListener("input", function () {
                this.style.height = "auto";
                this.style.height = Math.min(this.scrollHeight, 120) + "px";
            });

            // Send on Enter
            messageInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener("click", sendMessage);

            function sendQuickMessage(message) {
                messageInput.value = message;
                sendMessage();
            }

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                if (welcomeScreen) {
                    welcomeScreen.style.display = "none";
                }

                messageInput.disabled = true;
                sendButton.disabled = true;

                addMessage(message, "user", username);
                messageInput.value = "";
                messageInput.style.height = "auto";

                const typingIndicator = addTypingIndicator();

                try {
                    const response = await fetch(`${API_URL}/chat`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message: message,
                            username: username,
                        }),
                    });

                    const data = await response.json();
                    typingIndicator.remove();

                    if (response.ok) {
                        addMessage(
                            data.response,
                            "bot",
                            "EVA",
                            data.context_retrieved,
                            data.pii_masked,
                        );
                    } else {
                        addErrorMessage(
                            data.detail || "Failed to get response",
                        );
                    }
                } catch (error) {
                    typingIndicator.remove();
                    addErrorMessage("Connection error");
                    console.error("Error:", error);
                }

                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }

            function addMessage(
                text,
                type,
                sender,
                contextRetrieved = false,
                piiMasked = false,
            ) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${type}`;

                const now = new Date().toLocaleTimeString("en-US", {
                    hour: "numeric",
                    minute: "2-digit",
                });

                let badges = "";
                if (type === "bot" && contextRetrieved) {
                    badges += '<span class="message-badge">Personalized</span>';
                }

                messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">${type === "user" ? username[0].toUpperCase() : "ü§ñ"}</div>
                    <div class="message-sender">${sender}</div>
                    ${badges}
                </div>
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="message-time">${now}</div>
            `;

                const container = chatArea.querySelector(".chat-container");
                container.appendChild(messageDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            function addTypingIndicator() {
                const typingDiv = document.createElement("div");
                typingDiv.className = "message bot";
                typingDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-sender">EVA</div>
                </div>
                <div class="typing-indicator active">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
                const container = chatArea.querySelector(".chat-container");
                container.appendChild(typingDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
                return typingDiv;
            }

            function addErrorMessage(message) {
                const errorDiv = document.createElement("div");
                errorDiv.style.padding = "12px";
                errorDiv.style.background = "#e74c3c22";
                errorDiv.style.border = "1px solid #e74c3c";
                errorDiv.style.borderRadius = "8px";
                errorDiv.style.color = "#e74c3c";
                errorDiv.style.fontSize = "14px";
                errorDiv.style.margin = "16px 0";
                errorDiv.textContent = `‚ö†Ô∏è ${message}`;

                const container = chatArea.querySelector(".chat-container");
                container.appendChild(errorDiv);
                chatArea.scrollTop = chatArea.scrollHeight;

                setTimeout(() => errorDiv.remove(), 5000);
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML.replace(/\n/g, "<br>");
            }

            function newChat() {
                if (
                    confirm(
                        "Start a new conversation? Current chat will be cleared.",
                    )
                ) {
                    location.reload();
                }
            }

            async function exportChat() {
                try {
                    const response = await fetch(
                        `${API_URL}/history/${username}`,
                    );
                    const data = await response.json();

                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `eva-chat-${username}-${new Date().toISOString()}.json`;
                    a.click();
                } catch (error) {
                    alert("Failed to export chat");
                }
            }

            async function clearChat() {
                if (confirm("Clear all chat history?")) {
                    try {
                        await fetch(`${API_URL}/session/${username}`, {
                            method: "DELETE",
                        });
                        location.reload();
                    } catch (error) {
                        alert("Failed to clear chat");
                    }
                }
            }

            function logout() {
                if (confirm("Logout?")) {
                    localStorage.removeItem("eva_username");
                    localStorage.removeItem("eva_login_time");
                    window.location.href = "/login";
                }
            }
        </script>
    </body>
</html>
